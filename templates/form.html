{% extends 'base.html' %}

{% block title %}Nuevo formulario · SSMO{% endblock %}

{% block content %}
  <h2>Ingreso de datos médicos</h2>
  <p class="section-description">
    Complete el formulario con la información requerida. Al guardar, se generará una plantilla con los datos ingresados y el registro quedará almacenado en la base de datos.
  </p>

  {% if errores %}
    <div class="alert alert-error">
      <h3>Revise los siguientes campos:</h3>
      <ul>
        {% for error in errores %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" class="formulario">
    <section>
      <h3>Datos personales</h3>
      <div class="field-grid">
        <label>
          <span>Servicio de salud *</span>
          <input type="text" name="servicio_salud" value="Metropolitano Oriente" readonly required />
        </label>
        <label>
          <span>Nombre completo *</span>
          <input type="text" name="nombre_paciente" value="{{ campos.nombre_paciente }}" required />
        </label>
        <label>
          <span>Historia clínica</span>
          <input type="text" name="historia_clinica" value="{{ campos.historia_clinica }}" inputmode="text" pattern="[0-9]*" data-only-digits />
        </label>
        <label>
          <span>RUT paciente *</span>
          <input type="text" name="rut_pac" value="{{ campos.rut_pac }}" placeholder="11.111.111-1" data-rut required />
          <small class="field-note">Si el RUT termina en K, ingrese 0.</small>
        </label>
        <label>
          <span>Sexo</span>
          <select name="sexo">
            <option value="" disabled {% if not campos.sexo %}selected{% endif %}>Seleccione sexo</option>
            <option value="Femenino" {% if campos.sexo == 'Femenino' %}selected{% endif %}>Femenino</option>
            <option value="Masculino" {% if campos.sexo == 'Masculino' %}selected{% endif %}>Masculino</option>
            <option value="Otro" {% if campos.sexo == 'Otro' %}selected{% endif %}>Otro</option>
          </select>
        </label>
        <label>
          <span>Fecha de nacimiento *</span>
          <input type="date" name="fecha_nacimiento" value="{{ campos.fecha_nacimiento }}" required />
        </label>
        <label>
          <span>Edad</span>
          <input type="number" min="0" name="edad" value="{{ campos.edad }}" readonly />
        </label>
        <label class="wide">
          <span>Domicilio</span>
          <input type="text" name="domicilio" value="{{ campos.domicilio }}" />
        </label>
        <label>
          <span>Teléfono 1 *</span>
          <input type="tel" name="telefono1" value="{{ campos.telefono1 }}" required inputmode="tel" pattern="^\+?\d+$" data-phone placeholder="+56912345678" />
        </label>
        <label>
          <span>Teléfono 2</span>
          <input type="tel" name="telefono2" value="{{ campos.telefono2 }}" inputmode="tel" pattern="^\+?\d+$" data-phone placeholder="+56912345678" />
        </label>
        <label>
          <span>Correo electrónico 1 *</span>
          <input type="email" name="correo1" value="{{ campos.correo1 }}" required />
        </label>
        <label>
          <span>Correo electrónico 2</span>
          <input type="email" name="correo2" value="{{ campos.correo2 }}" />
        </label>
      </div>
    </section>

    <section>
      <h3>Datos médicos de la interconsulta (SIC)</h3>
      <div class="field-grid">

        {# --- Definir mapa estático comuna -> lista de nombres de establecimientos --- #}
        {# Ajusta o agrega establecimientos aquí según necesites. No toca la BDD. #}
        {% set mapa_comunas = {
          'Peñalolén': [
            'Cesfam Carol Urzúa', 'Cesfam La Faena', 'Cesfam Lo Hermida',
            'Cesfam San Luis', 'Cesfam Cardenal Silva Henríquez',
            'Cesfam Padre Whelan', 'Cesfam Las Torres'
          ],
          'Macul': ['Cesfam Félix de Amesti', 'Cesfam Santa Julia', 'Cesfam Alberto Hurtado'],
          'Ñuñoa': ['Cesfam Rosita Renard', 'Cesfam Salvador Bustos'],
          'La Reina': ['Cesfam Ossandón', 'Cesfam Juan Pablo II'],
          'Providencia': ['Cesfam Hernán Alessandri', 'Cesfam El Aguilucho', 'Cesfam Dr. Alfonso Leng'],
          'Las Condes': ['Cesfam Apoquindo', 'Cesfam Aníbal Ariztía'],
          'Vitacura': ['Cesfam Vitacura'],
          'Lo Barnechea': ['Cesfam Lo Barnechea']
        } %}

        <label>
          <span>Establecimiento de Origen *</span>
          <select name="id_est_orig" id="id_est_orig_select" required>
            <option value="">Seleccione un establecimiento</option>

            {# Grupo Salud Mental (COSAM SSMO) por separado si está en la BDD #}
            <optgroup label="Salud Mental">
              {% for est in establecimientos %}
                {% if est.nombre == 'COSAM SSMO' %}
                  <option value="{{ est.id_est }}" {% if campos.id_est_orig == est.id_est|string %}selected{% endif %}>{{ est.nombre }} — Salud Mental</option>
                {% endif %}
              {% endfor %}
            </optgroup>

            {# Recorrer el mapa de comunas y mostrar sólo los establecimientos que están en la BDD #}
            {% for comuna, lista_nombres in mapa_comunas.items() %}
              <optgroup label="{{ comuna }}">
                {% for est in establecimientos %}
                  {% if est.nombre in lista_nombres %}
                    <option value="{{ est.id_est }}" {% if campos.id_est_orig == est.id_est|string %}selected{% endif %}>{{ est.nombre }}</option>
                  {% endif %}
                {% endfor %}
              </optgroup>
            {% endfor %}

            {# Opcional: listar cualquier establecimiento que no esté en el mapa bajo "Otros" #}
            <optgroup label="Otros">
              {% for est in establecimientos %}
                {% if est.nombre != 'COSAM SSMO' and (est.nombre not in (mapa_comunas.values() | join(','))) %}
                  <option value="{{ est.id_est }}" {% if campos.id_est_orig == est.id_est|string %}selected{% endif %}>{{ est.nombre }}</option>
                {% endif %}
              {% endfor %}
            </optgroup>

          </select>
        </label>

        <label>
          <span>Establecimiento de Destino *</span>
          <select name="id_est_dest" id="id_est_dest_select" required>
            <option value="">Seleccione un establecimiento</option>

            {# Grupo Salud Mental (COSAM SSMO) por separado si está en la BDD #}
            <optgroup label="Salud Mental">
              {% for est in establecimientos %}
                {% if est.nombre == 'COSAM SSMO' %}
                  <option value="{{ est.id_est }}" {% if campos.id_est_dest == est.id_est|string %}selected{% endif %}>{{ est.nombre }} — Salud Mental</option>
                {% endif %}
              {% endfor %}
            </optgroup>

            {# Mismo mapa de comunas para el select destino #}
            {% for comuna, lista_nombres in mapa_comunas.items() %}
              <optgroup label="{{ comuna }}">
                {% for est in establecimientos %}
                  {% if est.nombre in lista_nombres %}
                    <option value="{{ est.id_est }}" {% if campos.id_est_dest == est.id_est|string %}selected{% endif %}>{{ est.nombre }}</option>
                  {% endif %}
                {% endfor %}
              </optgroup>
            {% endfor %}

            {# Opcional: listar cualquier establecimiento que no esté en el mapa bajo "Otros" #}
            <optgroup label="Otros">
              {% for est in establecimientos %}
                {% if est.nombre != 'COSAM SSMO' and (est.nombre not in (mapa_comunas.values() | join(','))) %}
                  <option value="{{ est.id_est }}" {% if campos.id_est_dest == est.id_est|string %}selected{% endif %}>{{ est.nombre }}</option>
                {% endif %}
              {% endfor %}
            </optgroup>

          </select>
        </label>

        <label>
          <span>Especialidad de Origen</span>
          <select name="especialidad_orig">
            <option value="" disabled {% if not campos.especialidad_orig %}selected{% endif %}>Seleccione especialidad</option>
            <option value="Psiquiatría Adulto" {% if campos.especialidad_orig == 'Psiquiatría Adulto' %}selected{% endif %}>Psiquiatría Adulto</option>
            <option value="Psiquiatra Infanto Adolescente" {% if campos.especialidad_orig == 'Psiquiatra Infanto Adolescente' %}selected{% endif %}>Psiquiatra Infanto Adolescente</option>
            <option value="Químico Farmacéutico" {% if campos.especialidad_orig == 'Químico Farmacéutico' %}selected{% endif %}>Químico Farmacéutico</option>
            <option value="Psicólogo(a)" {% if campos.especialidad_orig == 'Psicólogo(a)' %}selected{% endif %}>Psicólogo(a)</option>
            <option value="Trabajador(a) Social" {% if campos.especialidad_orig == 'Trabajador(a) Social' %}selected{% endif %}>Trabajador(a) Social</option>
            <option value="Terapeuta Ocupacional" {% if campos.especialidad_orig == 'Terapeuta Ocupacional' %}selected{% endif %}>Terapeuta Ocupacional</option>
            <option value="Enfermera(o)" {% if campos.especialidad_orig == 'Enfermera(o)' %}selected{% endif %}>Enfermera(o)</option>
            <option value="Psicopedagogo(a)" {% if campos.especialidad_orig == 'Psicopedagogo(a)' %}selected{% endif %}>Psicopedagogo(a)</option>
          </select>
        </label>

        <label>
          <span>Especialidad de Destino</span>
          <select name="especialidad_dest">
            <option value="" disabled {% if not campos.especialidad_dest %}selected{% endif %}>Seleccione especialidad</option>
            <option value="Psiquiatría Adulto" {% if campos.especialidad_dest == 'Psiquiatría Adulto' %}selected{% endif %}>Psiquiatría Adulto</option>
            <option value="Psiquiatra Infanto Adolescente" {% if campos.especialidad_dest == 'Psiquiatra Infanto Adolescente' %}selected{% endif %}>Psiquiatra Infanto Adolescente</option>
            <option value="Químico Farmacéutico" {% if campos.especialidad_dest == 'Químico Farmacéutico' %}selected{% endif %}>Químico Farmacéutico</option>
            <option value="Psicólogo(a)" {% if campos.especialidad_dest == 'Psicólogo(a)' %}selected{% endif %}>Psicólogo(a)</option>
            <option value="Trabajador(a) Social" {% if campos.especialidad_dest == 'Trabajador(a) Social' %}selected{% endif %}>Trabajador(a) Social</option>
            <option value="Terapeuta Ocupacional" {% if campos.especialidad_dest == 'Terapeuta Ocupacional' %}selected{% endif %}>Terapeuta Ocupacional</option>
            <option value="Enfermera(o)" {% if campos.especialidad_dest == 'Enfermera(o)' %}selected{% endif %}>Enfermera(o)</option>
            <option value="Psicopedagogo(a)" {% if campos.especialidad_dest == 'Psicopedagogo(a)' %}selected{% endif %}>Psicopedagogo(a)</option>
          </select>
        </label>

        <label>
          <span>Tipo de consulta</span>
          <select name="tipo_consulta" data-consulta-selector>
            <option value="" disabled {% if not campos.tipo_consulta %}selected{% endif %}>Seleccione tipo de consulta</option>
            {% for opcion in tipos_consulta_catalogo %}
              <option value="{{ opcion }}" {% if campos.tipo_consulta == opcion %}selected{% endif %}>{{ opcion }}</option>
            {% endfor %}
          </select>
        </label>

        <label class="wide" data-consulta-otro {% if campos.tipo_consulta != 'Otro' %}hidden{% endif %}>
          <span>Detalle del tipo de consulta</span>
          <input type="text" name="tipo_consulta_otro" value="{{ campos.tipo_consulta_detalle or '' }}" placeholder="Especifique el motivo" />
        </label>

        <label>
          <span>¿Requiere terapias específicas?</span>
          <select name="tiene_terapias">
            <option value="" disabled {% if not campos.tiene_terapias %}selected{% endif %}>Seleccione</option>
            <option value="Sí" {% if campos.tiene_terapias == 'Sí' %}selected{% endif %}>Sí</option>
            <option value="No" {% if campos.tiene_terapias == 'No' %}selected{% endif %}>No</option>
          </select>
        </label>

        <label class="wide">
          <span>Hipótesis diagnóstica *</span>
          <textarea name="diagnostico" rows="3" required>{{ campos.diagnostico }}</textarea>
        </label>

        <label class="wide">
          <span>¿Caso GES?</span>
          <select name="ges">
            <option value="" disabled {% if not campos.ges %}selected{% endif %}>Seleccione</option>
            <option value="Sí" {% if campos.ges == 'Sí' %}selected{% endif %}>Sí</option>
            <option value="No" {% if campos.ges == 'No' %}selected{% endif %}>No</option>
          </select>
        </label>

        <label class="wide">
          <span>Exámenes realizados</span>
          <textarea name="examenes" rows="3">{{ campos.examenes }}</textarea>
        </label>

        <label>
          <span>Prioridad</span>
          <select name="prioridad">
            <option value="" disabled {% if not campos.prioridad %}selected{% endif %}>Seleccione prioridad</option>
            <option value="Alta" {% if campos.prioridad == 'Alta' %}selected{% endif %}>Alta</option>
            <option value="Media" {% if campos.prioridad == 'Media' %}selected{% endif %}>Media</option>
            <option value="Baja" {% if campos.prioridad == 'Baja' %}selected{% endif %}>Baja</option>
          </select>
        </label>

      </div>
    </section>

    <section>
      <h3>Patologías GES</h3>
      <p class="section-description">Seleccione todas las patologías que apliquen.</p>
      <div class="checkbox-grid">
        {% set seleccionadas = campos.patologias_ges.split(';') if campos.patologias_ges else [] %}
        {% set patologias_ges_catalogo = [
            'Esquizofrenia',
            'Depresión (para mayores de 15 años)',
            'Trastorno bipolar (para mayores de 15 años)',
            'Demencia (incluida la enfermedad de Alzheimer)',
            'Consumo problemático de alcohol y drogas en menores de 20 años (riesgo bajo a moderado)',
            'Tratamiento de hospitalización para menores de 15 años con depresión grave'
        ] %}
        {% for patologia in patologias_ges_catalogo %}
          <label class="checkbox-item">
            <input type="checkbox" name="patologias_ges" value="{{ patologia }}" {% if patologia in seleccionadas %}checked{% endif %} />
            <span>{{ patologia }}</span>
          </label>
        {% endfor %}
      </div>
    </section>

    <section>
      <h3>Profesional responsable</h3>
      <div class="field-grid">
        <label>
          <span>Nombre médico *</span>
          <input type="text" name="nombre_medico" value="{{ campos.nombre_medico }}" required/>
        </label>
        <label>
          <span>RUT médico *</span>
          <input type="text" name="rut_pro" value="{{ campos.rut_pro }}" placeholder="33.333.333-3" data-rut required/>
          <small class="field-note">Si el RUT termina en K, ingrese 0.</small>
        </label>
      </div>
    </section>

    <div class="actions">
      <button type="submit" class="primary">Guardar formulario</button>
      <a class="secondary" href="{{ url_for('listar_formularios') }}">Ver registros existentes</a>
    </div>
  </form>

  <style>
    .readonly-style {
      pointer-events: none;
      background-color: #e9ecef;
      opacity: 1;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const origenSelect = document.getElementById('id_est_orig_select');
      const destinoSelect = document.getElementById('id_est_dest_select');
      const cosamValue = '22';

      function actualizarDestino() {
        const origenId = origenSelect.value;

        // Reset styles and state first
        destinoSelect.classList.remove('readonly-style');
        for (let option of destinoSelect.options) {
            option.hidden = false;
        }

        if (origenId && origenId !== cosamValue) {
          // Origen es un CESFAM, destino debe ser COSAM
          destinoSelect.value = cosamValue;
          destinoSelect.classList.add('readonly-style');
        } else if (origenId === cosamValue) {
          // Origen es COSAM, destino puede ser cualquier CESFAM
          if (destinoSelect.value === cosamValue) {
            destinoSelect.value = ''; // Reset selection
          }
          // Ocultar COSAM de las opciones de destino
          for (let option of destinoSelect.options) {
            option.hidden = (option.value === cosamValue);
          }
        } else {
          // No hay origen seleccionado, resetear destino
          destinoSelect.value = '';
        }
      }

      // Ejecutar al cargar la página y cada vez que cambie el origen
      origenSelect.addEventListener('change', actualizarDestino);
      actualizarDestino();
    });
  </script>
{% endblock %}

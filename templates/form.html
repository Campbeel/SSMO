{% extends 'base.html' %}

{% block title %}Nuevo formulario - SSMO{% endblock %}

{% block content %}
  <h2>Ingreso de datos médicos</h2>
  <p class="section-description">
    Complete el formulario con la información requerida. Al guardar, se generará una plantilla con los datos ingresados y el registro quedará almacenado en la base de datos.
  </p>

  {% if errores %}
    <div class="alert alert-error">
      <h3>Revise los siguientes campos:</h3>
      <ul>
        {% for error in errores %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" class="formulario">
    <section>
      <h3>Datos personales</h3>
      <div class="field-grid">
        <label>
          <span>Servicio de salud *</span>
          <input type="text" name="servicio_salud" value="{{ campos.servicio_salud }}" required />
        </label>
        <label>
          <span>Establecimiento</span>
          <input type="text" name="establecimiento" value="{{ campos.establecimiento }}" />
        </label>
        <label>
          <span>Especialidad</span>
          <input type="text" name="especialidad" value="{{ campos.especialidad }}" />
        </label>
        <label>
          <span>Unidad</span>
          <input type="text" name="unidad" value="{{ campos.unidad }}" />
        </label>
        <label>
          <span>Nombre completo *</span>
          <input type="text" name="nombre" value="{{ campos.nombre }}" required />
        </label>
        <label>
          <span>Historia clínica</span>
          <input type="text" name="historia_clinica" value="{{ campos.historia_clinica }}" inputmode="numeric" pattern="[0-9]*" data-only-digits />
        </label>
        <label>
          <span>RUT paciente *</span>
          <input type="text" name="rut" value="{{ campos.rut }}" placeholder="11.111.111-1" data-rut required />
          <small class="field-note">Si el RUT termina en K, ingrese 0.</small>
        </label>
        <label>
          <span>RUT apoderado/padre (opcional)</span>
          <input type="text" name="rut_padre" value="{{ campos.rut_padre }}" placeholder="22.222.222-2" data-rut />
          <small class="field-note">Si el RUT termina en K, ingrese 0.</small>
        </label>
        <label>
          <span>Sexo</span>
          <select name="sexo">
            <option value="" disabled {% if not campos.sexo %}selected{% endif %}>Seleccione sexo</option>
            <option value="Femenino" {% if campos.sexo == 'Femenino' %}selected{% endif %}>Femenino</option>
            <option value="Masculino" {% if campos.sexo == 'Masculino' %}selected{% endif %}>Masculino</option>
            <option value="Otro" {% if campos.sexo == 'Otro' %}selected{% endif %}>Otro</option>
          </select>
        </label>
        <label>
          <span>Fecha de nacimiento *</span>
          <input type="date" name="fecha_nacimiento" value="{{ campos.fecha_nacimiento }}" required />
        </label>
        <label>
          <span>Edad</span>
          <input type="number" min="0" name="edad" value="{{ campos.edad }}" readonly />
        </label>
        <label class="wide">
          <span>Domicilio</span>
          <input type="text" name="domicilio" value="{{ campos.domicilio }}" />
        </label>
        <label>
          <span>Comuna</span>
          <select name="comuna">
            <option value="" disabled {% if not campos.comuna %}selected{% endif %}>Seleccione una comuna</option>
            {% for comuna in comunas_catalogo %}
              <option value="{{ comuna }}" {% if campos.comuna == comuna %}selected{% endif %}>{{ comuna }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <span>Teléfono 1 *</span>
          <input type="tel" name="telefono1" value="{{ campos.telefono1 }}" required inputmode="tel" pattern="^\+?\d+$" data-phone placeholder="+56912345678" />
        </label>
        <label>
          <span>Teléfono 2</span>
          <input type="tel" name="telefono2" value="{{ campos.telefono2 }}" inputmode="tel" pattern="^\+?\d+$" data-phone placeholder="+56912345678" />
        </label>
        <label>
          <span>Correo electrónico 1 *</span>
          <input type="email" name="correo1" value="{{ campos.correo1 }}" required />
        </label>
        <label>
          <span>Correo electrónico 2</span>
          <input type="email" name="correo2" value="{{ campos.correo2 }}" />
        </label>
      </div>
    </section>

    <section>
      <h3>Datos médicos</h3>
      <div class="field-grid">
        <label>
          <span>Establecimiento de derivación</span>
          <input type="text" name="establecimiento_derivacion" value="{{ campos.establecimiento_derivacion }}" />
        </label>
        <label>
          <span>Grupo poblacional específico</span>
          <select name="grupo_poblacional">
            <option value="" disabled {% if not campos.grupo_poblacional %}selected{% endif %}>Seleccione</option>
            <option value="Sí" {% if campos.grupo_poblacional == 'Sí' %}selected{% endif %}>Sí</option>
            <option value="No" {% if campos.grupo_poblacional == 'No' %}selected{% endif %}>No</option>
          </select>
        </label>
        <label>
          <span>Tipo de consulta</span>
          <select name="tipo_consulta" data-consulta-selector>
            <option value="" disabled {% if not campos.tipo_consulta %}selected{% endif %}>Seleccione tipo de consulta</option>
            {% for opcion in tipos_consulta_catalogo %}
              <option value="{{ opcion }}" {% if campos.tipo_consulta == opcion %}selected{% endif %}>{{ opcion }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="wide" data-consulta-otro {% if campos.tipo_consulta != 'Otro' %}hidden{% endif %}>
          <span>Detalle del tipo de consulta</span>
          <input type="text" name="tipo_consulta_otro" value="{{ campos.tipo_consulta_detalle or '' }}" placeholder="Especifique el motivo" />
        </label>
        <label>
          <span>¿Requiere terapias específicas?</span>
          <select name="tiene_terapias">
            <option value="" disabled {% if not campos.tiene_terapias %}selected{% endif %}>Seleccione</option>
            <option value="Sí" {% if campos.tiene_terapias == 'Sí' %}selected{% endif %}>Sí</option>
            <option value="No" {% if campos.tiene_terapias == 'No' %}selected{% endif %}>No</option>
          </select>
        </label>
        <label class="wide">
          <span>Hipótesis diagnóstica</span>
          <textarea name="hipotesis_diagnostico" rows="3">{{ campos.hipotesis_diagnostico }}</textarea>
        </label>
        <label class="wide">
          <span>¿Caso GES?</span>
          <select name="es_ges">
            <option value="" disabled {% if not campos.es_ges %}selected{% endif %}>Seleccione</option>
            <option value="Sí" {% if campos.es_ges == 'Sí' %}selected{% endif %}>Sí</option>
            <option value="No" {% if campos.es_ges == 'No' %}selected{% endif %}>No</option>
          </select>
        </label>
        <label class="wide">
          <span>Fundamento diagnóstico</span>
          <textarea name="fundamento_diagnostico" rows="3">{{ campos.fundamento_diagnostico }}</textarea>
        </label>
        <label class="wide">
          <span>Exámenes realizados</span>
          <textarea name="examenes_realizados" rows="3">{{ campos.examenes_realizados }}</textarea>
        </label>
      </div>
    </section>

    <section>
      <h3>Patologías GES</h3>
      <p class="section-description">Seleccione todas las patologías que apliquen.</p>
      <div class="checkbox-grid">
        {% set seleccionadas = campos.patologias_ges.split(';') if campos.patologias_ges else [] %}
        {% for patologia in patologias_catalogo %}
          <label class="checkbox-item">
            <input type="checkbox" name="patologias_ges" value="{{ patologia }}" {% if patologia in seleccionadas %}checked{% endif %} />
            <span>{{ patologia }}</span>
          </label>
        {% endfor %}
      </div>
    </section>

    <section>
      <h3>Datos del (la) Profesional </h3>
      <div class="field-grid">
        <label>
          <span>Nombre médico</span>
          <input type="text" name="nombre_medico" value="{{ campos.nombre_medico }}" />
        </label>
        <label>
          <span>RUT médico</span>
          <input type="text" name="rut_medico" value="{{ campos.rut_medico }}" placeholder="33.333.333-3" data-rut />
          <small class="field-note">Si el RUT termina en K, ingrese 0.</small>
        </label>
      </div>
    </section>

    <div class="actions">
      <button type="submit" class="primary">Guardar formulario</button>
      <a class="secondary" href="{{ url_for('listar_formularios') }}">Ver registros existentes</a>
    </div>
  </form>
{% endblock %}
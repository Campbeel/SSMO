{% extends 'base.html' %}

{% block title %}Nuevo formulario - SSMO{% endblock %}

{% block content %}
  <h2>Ingreso de datos médicos</h2>
  <p class="section-description">
    Complete el formulario con la información requerida. Al guardar, se generará una plantilla con los datos ingresados y el registro quedará almacenado en la base de datos.
  </p>

  {% if errores %}
    <div class="alert alert-error">
      <h3>Revise los siguientes campos:</h3>
      <ul>
        {% for error in errores %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" class="formulario">
    <!-- Bloque superior: 1) Servicio, 2) Comuna , 3) Establecimiento , 4) Especialidad -->
    <section class="admission-box">
      <h3>Admisión</h3>
      <div class="field-grid">
        <label>
          <span>Servicio de salud </span>
          <input type="text" name="servicio_salud" value="{{ campos.servicio_salud }}" required readonly aria-readonly="true" />
        </label>
        <label data-compact>
          <span>Comuna</span>
          <select name="admision_comuna" data-est-comuna>
            <option value="" disabled selected>Seleccione una comuna</option>
            {% for comuna in establecimientos_catalogo.keys() %}
              <option value="{{ comuna }}">{{ comuna }}</option>
            {% endfor %}
          </select>
        </label>
        <label data-compact>
          <span>Establecimiento </span>
          <select name="establecimiento" data-est-select>
            <option value="" disabled {% if not campos.establecimiento %}selected{% endif %}>Seleccione un establecimiento</option>
          </select>
        </label>
        <label>
          <span>Especialidad</span>
          <select name="especialidad">
            <option value="" disabled {% if not campos.especialidad %}selected{% endif %}>Seleccione especialidad</option>
            {% for esp in especialidades_catalogo %}
              <option value="{{ esp }}" {% if campos.especialidad == esp %}selected{% endif %}>{{ esp }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <span>Unidad</span>
          <input type="text" name="unidad" value="{{ campos.unidad }}" />
        </label>
      </div>
      <script>
        window.EST_CATALOGO = {{ establecimientos_catalogo | tojson }};
        window.EST_PRESELECCIONADO = {{ (campos.establecimiento or '') | tojson }};
      </script>
    </section>

    <!-- Datos personales -->
    <section>
      <h3>Datos del (de la) Paciente</h3>
      <div class="field-grid">
        <label>
          <span>Nombre completo *</span>
          <input type="text" name="nombre" value="{{ campos.nombre }}" required />
        </label>
        <label>
          <span>Historia clínica</span>
          <input type="text" name="historia_clinica" value="{{ campos.historia_clinica }}" placeholder="" />
        </label>
        <label>
          <span>RUT paciente *</span>
          <input type="text" name="rut" value="{{ campos.rut }}" placeholder="11.111.111-1" data-rut required />
          <small class="field-note">Si el RUT termina en K, ingrese 0.</small>
        </label>
        <label>
          <span>RUT apoderado/padre (opcional)</span>
          <input type="text" name="rut_padre" value="{{ campos.rut_padre }}" placeholder="" data-rut />
          <small class="field-note">Si el RUT termina en K, ingrese 0.</small>
        </label>
        <label>
          <span>Sexo</span>
          <select name="sexo">
            <option value="" disabled {% if not campos.sexo %}selected{% endif %}>Seleccione sexo</option>
            <option value="Femenino" {% if campos.sexo == 'Femenino' %}selected{% endif %}>Femenino</option>
            <option value="Masculino" {% if campos.sexo == 'Masculino' %}selected{% endif %}>Masculino</option>
            <option value="Otro" {% if campos.sexo == 'Otro' %}selected{% endif %}>Otro</option>
          </select>
        </label>
        <label>
          <span>Fecha de nacimiento *</span>
          <input type="date" name="fecha_nacimiento" value="{{ campos.fecha_nacimiento }}" required />
        </label>
        <label>
          <span>Edad</span>
          <input type="number" min="0" name="edad" value="{{ campos.edad }}" readonly />
        </label>
        <label class="wide">
          <span>Domicilio</span>
          <input type="text" name="domicilio" value="{{ campos.domicilio }}" />
        </label>
        <label>
          <span>Comuna</span>
          <select name="comuna">
            <option value="" disabled {% if not campos.comuna %}selected{% endif %}>Seleccione una comuna</option>
            {% for comuna in comunas_catalogo %}
              <option value="{{ comuna }}" {% if campos.comuna == comuna %}selected{% endif %}>{{ comuna }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <span>Teléfono 1 *</span>
          <input type="tel" name="telefono1" value="{{ campos.telefono1 }}" required inputmode="tel" pattern="^\+?\d+$" data-phone placeholder="+56912345678" />
        </label>
        <label>
          <span>Teléfono 2</span>
          <input type="tel" name="telefono2" value="{{ campos.telefono2 }}" inputmode="tel" pattern="^\+?\d+$" data-phone placeholder="" />
        </label>
        <label>
          <span>Correo electrónico 1 *</span>
          <input type="email" name="correo1" value="{{ campos.correo1 }}" required />
        </label>
        <label>
          <span>Correo electrónico 2</span>
          <input type="email" name="correo2" value="{{ campos.correo2 }}" />
        </label>
      </div>
    </section>

    <section>
      <h3>Datos médicos</h3>
      <div class="field-grid">
        <label data-compact>
          <span>Comuna destino</span>
          <select name="derivacion_comuna" data-der-comuna>
            <option value="" disabled selected>Seleccione una comuna</option>
            {% for comuna in establecimientos_catalogo.keys() %}
              <option value="{{ comuna }}">{{ comuna }}</option>
            {% endfor %}
          </select>
        </label>
        <label data-compact>
          <span>Establecimiento destino </span>
          <select name="establecimiento_derivacion" data-der-select>
            <option value="" disabled {% if not campos.establecimiento_derivacion %}selected{% endif %}>Seleccione un establecimiento</option>
          </select>
        </label>
        <script>
          window.DER_PRESELECCIONADO = {{ (campos.establecimiento_derivacion or '') | tojson }};
        </script>
        <label>
          <span>Grupo poblacional específico</span>
          <select name="grupo_poblacional">
            <option value="" disabled {% if not campos.grupo_poblacional %}selected{% endif %}>Seleccione</option>
            <option value="Sí" {% if campos.grupo_poblacional == 'Sí' %}selected{% endif %}>Sí</option>
            <option value="No" {% if campos.grupo_poblacional == 'No' %}selected{% endif %}>No</option>
          </select>
        </label>
        <label>
          <span>Tipo de consulta</span>
          <select name="tipo_consulta" data-consulta-selector>
            <option value="" disabled {% if not campos.tipo_consulta %}selected{% endif %}>Seleccione tipo de consulta</option>
            {% for opcion in tipos_consulta_catalogo %}
              <option value="{{ opcion }}" {% if campos.tipo_consulta == opcion %}selected{% endif %}>{{ opcion }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="wide" data-consulta-otro {% if campos.tipo_consulta != 'Otro' %}hidden{% endif %}>
          <span>Detalle del tipo de consulta (si seleccionó otro) </span>
          <input type="text" name="tipo_consulta_otro" value="{{ campos.tipo_consulta_detalle or '' }}" placeholder="Especifique el motivo" />
        </label>
        <label>
          <span>¿Requiere terapias específicas?</span>
          <select name="tiene_terapias">
            <option value="" disabled {% if not campos.tiene_terapias %}selected{% endif %}>Seleccione</option>
            <option value="Sí" {% if campos.tiene_terapias == 'Sí' %}selected{% endif %}>Sí</option>
            <option value="No" {% if campos.tiene_terapias == 'No' %}selected{% endif %}>No</option>
          </select>
        </label>
        <label class="wide">
          <span>Hipótesis diagnóstica</span>
          <textarea name="hipotesis_diagnostico" rows="3">{{ campos.hipotesis_diagnostico }}</textarea>
        </label>
        <!-- Eliminado '¿Caso GES?'; se maneja por selección de patología -->
        <label class="wide">
          <span>Fundamento diagnóstico</span>
          <textarea name="fundamento_diagnostico" rows="3">{{ campos.fundamento_diagnostico }}</textarea>
        </label>
        <label class="wide">
          <span>Exámenes realizados</span>
          <textarea name="examenes_realizados" rows="3">{{ campos.examenes_realizados }}</textarea>
        </label>
      </div>
    </section>

    <section>
          <section>
      <h3>Patologías GES</h3>
      <p class="section-description">Seleccione la patología si corresponde; deje sin selección si no aplica.</p>
      {% set seleccionada = (campos.patologias_ges.split(';')[0]) if campos.patologias_ges else '' %}
      <div class="field-grid">
        <label class="wide">
          <span>Patología GES</span>
          <select name="patologias_ges">
            <option value="" {% if not seleccionada %}selected{% endif %}>Sin selección</option>
            {% for patologia in patologias_catalogo %}
              <option value="{{ patologia }}" {% if seleccionada == patologia %}selected{% endif %}>{{ patologia }}</option>
            {% endfor %}
          </select>
        </label>
      </div>
    </section> 

    <section>
      <h3>Profesional responsable</h3>
      <div class="field-grid">
        <label>
          <span>Nombre</span>
          <input type="text" name="nombre_medico" value="{{ campos.nombre_medico }}" />
        </label>
        <label>
          <span>RUT </span>
          <input type="text" name="rut_medico" value="{{ campos.rut_medico }}" placeholder="1.111.111-1" data-rut />
          <small class="field-note">Si el RUT termina en K, ingrese 0.</small>
        </label>
      </div>
    </section>

    <div class="actions">
      <button type="submit" class="primary">Guardar formulario</button>
      <a class="secondary" href="{{ url_for('listar_formularios') }}">Ver registros existentes</a>
    </div>
  </form>
{% endblock %}

{% extends 'base.html' %}

{% block title %}Admin usuarios - SSMO{% endblock %}

{% block content %}
  {% if domain_suffix %}
    <style>
      .domain-input {
        display: flex;
        align-items: center;
        gap: 0.8rem;
      }
      .domain-input .suffix {
        font-weight: 600;
      }
      .domain-input input {
        flex: 1;
      }
    </style>
  {% endif %}
  <h2>Usuarios</h2>
  <form method="post" class="formulario" id="user-create-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <div class="field-grid">
      <label>
        <span>Correo (usuario)</span>
        {% if domain_suffix %}
          <div class="domain-input">
            <input type="text" name="username" required placeholder="usuario" />
            <span class="suffix">{{ domain_suffix }}</span>
          </div>
          <small>Solo escribe el nombre antes del dominio; se completará automáticamente.</small>
        {% else %}
          <input type="email" name="username" required />
        {% endif %}
      </label>
      <label>
        <span>Rol</span>
        <select name="role" required>
          {% for opt in allowed_roles %}
            <option value="{{ opt }}">{{ opt }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        <span>Contraseña</span>
        <input type="password" name="password" minlength="8" required />
      </label>
      <label class="toggle-field doctor-toggle" data-doctor-toggle>
        <span>Ingresar datos médico</span>
        <span class="toggle-switch">
          <input type="checkbox" name="doctor_info" id="doctor-info-create" />
          <span class="slider"></span>
        </span>
      </label>
      <div class="doctor-fields">
        <label>
          <span>Nombre del médico</span>
          <input type="text" name="doctor_name" />
        </label>
        <label>
          <span>RUT del médico</span>
          <input type="text" name="doctor_rut" placeholder="12.345.678-9" />
        </label>
      </div>
      {% if is_master %}
      <label class="toggle-field">
        <span>Admin maestro</span>
        <span class="toggle-switch">
          <input type="checkbox" name="is_master_admin" />
          <span class="slider"></span>
        </span>
      </label>
      {% endif %}
    </div>
    <div class="actions">
      <button class="primary" type="submit">Crear</button>
    </div>
  </form>

  <h3>Lista</h3>
  <table class="entries-table">
    <thead>
      <tr>
        <th>Usuario</th>
        <th>Rol</th>
        <th>Master</th>
        <th>Activo</th>
        <th>Creado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
        <tr>
          <td>{{ u.username }}</td>
          <td>{{ u.role }}</td>
          <td>{{ 'sí' if u.is_master_admin else 'no' }}</td>
          <td>{{ 'sí' if u.is_active else 'no' }}</td>
          <td>{{ u.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
          <td>
            <a class="secondary" href="{{ url_for('admin_user_edit', user_id=u.id) }}">Editar</a>
            {% if u.id != (current_user.id if current_user else -1) and (is_master or not u.is_master_admin) %}
              <form action="{{ url_for('admin_user_delete', user_id=u.id) }}" method="post" style="display:inline" onsubmit="return confirm('¿Eliminar usuario {{ u.username }}?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button type="submit" class="danger">Eliminar</button>
              </form>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="actions" style="margin-top:1rem;">
    <a class="secondary" href="{{ url_for('admin_ges') }}">Gestionar GES</a>
  </div>
  <script>
    (function () {
      const doctorRoles = {{ doctor_roles|tojson }};
      const form = document.getElementById("user-create-form");
      if (!form) return;
      const roleSelect = form.querySelector('select[name="role"]');
      const toggleRow = form.querySelector('[data-doctor-toggle]');
      const doctorCheckbox = form.querySelector('input[name="doctor_info"]');
      const doctorFields = form.querySelector('.doctor-fields');
      function applyDoctorState() {
        const enabledRole = roleSelect && doctorRoles.includes(roleSelect.value);
        if (toggleRow) {
          toggleRow.style.display = enabledRole ? "flex" : "none";
        }
        if (!enabledRole) {
          doctorCheckbox.checked = false;
        }
        if (doctorFields) {
          if (doctorCheckbox.checked && enabledRole) {
            doctorFields.classList.add("active");
          } else {
            doctorFields.classList.remove("active");
          }
        }
      }
      if (roleSelect && doctorCheckbox) {
        roleSelect.addEventListener("change", applyDoctorState);
        doctorCheckbox.addEventListener("change", applyDoctorState);
      }
      applyDoctorState();
    })();
  </script>
{% endblock %}

